/*! pager.js - v1.0.1 - 2014-03-12
* http://oscar.finnsson.nu/pagerjs/
* Copyright (c) 2014 Oscar Finnsson; Licensed MIT */

!function(e){var t=function(t,n){"use strict";var a=function(e,t){return function(){var a=arguments;return n.computed(function(){return e.apply(t,a)})}},r={};r.page=null,r.now=function(){return Date.now?Date.now():(new Date).valueOf()},r.extendWithPage=function(e){var t=new r.Page;e.$__page__=t,r.page=t,r.activePage$=a(r.getActivePage,r)()};var i=function(e,t,n){n=n||{},n.page=e,r[t].fire(n),e.val(t)&&e.val(t)(n)};t.each(["onBindingError","onSourceError","onNoMatch","onMatch","beforeRemove","afterRemove","beforeHide","afterHide","beforeShow","afterShow"],function(e,n){r[n]=t.Callbacks()}),r.showChild=function(e){var t=e&&1===e.length&&""===e[0]?[]:e;r.page.showPage(t)},r.getParentPage=function(e){for(;e;){if(e.$page&&"none"!==e.$page.val("urlToggle"))return e.$page;if(e.$data&&e.$data.$__page__)return e.$data.$__page__;e=e.$parentContext}return null};var o=null,l=null,s=function(e){l&&l.reject({cancel:!0}),o=null,e.substring(0,r.Href.hash.length)===r.Href.hash&&(e=e.slice(r.Href.hash.length));var t=u(e);r.showChild(t)};r.goTo=s,r.navigate=function(e){r.useHTML5history?r.Href5.history.pushState(null,null,e):location.hash=e};var u=function(e){return t.map(e.replace(/\+/g," ").split("/"),decodeURIComponent)},h={};h.value=n.utils.unwrapObservable,h.arrayValue=function(e){return t.map(e,function(e){return h.value(e)})};var c=function(e){for(var t,n={},a=/([^&=]+)=?([^&]*)/g;t=a.exec(e);)n[t[1]]=t[2];return n},d=function(e){if(!e)return{name:null,params:{}};var t=e.split("?"),n=t[0],a=t[1],r={};return a&&(r=c(a)),{name:n,params:r}};r.ChildManager=function(e,a){this.currentChildO=n.observable(null);var o=this;this.page=a,this.timeStamp=r.now(),this.hideChild=function(){var e=o.currentChildO();e&&(e.hidePage(function(){}),o.currentChildO(null))},this.showChild=function(n){var a=0===n.length;this.timeStamp=r.now();var l=this.timeStamp,s=o.currentChildO(),u=null,c=!1,f=d(n[0]),g=f.name,v=null;t.each(e(),function(e,t){if(!c){var n=t.getId();(n===g||(""===g||null==g)&&t.isStartPage())&&(c=!0,u=t),"?"===n&&(v=t)}});for(var p=!1,m=o,b=function(e,t){if(!c){var n=t.getId(),a=t.getValue().modal;a&&((n===g||(""===g||null==g)&&t.isStartPage())&&(c=!0,u=t,p=!0),"?"!==n||v||(v=t,p=!0))}};!u&&m.page.parentPage&&!m.page.getValue().modal;){var w=m.page.parentPage.children;t.each(w(),b),u||(m=m.page.parentPage.childManager)}u||!v||a||(u=v),o.currentChildO(u),u&&u.currentParentPage(p?o.page:null);var x=function(){i(o.page,"onNoMatch",{route:n})},P=function(){i(o.page,"onMatch",{route:n});var e=h.value(u.getValue().guard);e?e(u,n,function(){o.timeStamp===l&&u.showPage(n.slice(1),f,n[0])},s):u.showPage(n.slice(1),f,n[0])};s&&s===u?P():s?s.hidePage(function(){u?P():x()}):u?P():x()}},r.Page=function(e,t,a,i,o){this.element=e,this.valueAccessor=t,this.allBindingsAccessor=a,this.viewModel=i,this.bindingContext=o,this.children=n.observableArray([]),this.childManager=new r.ChildManager(this.children,this),this.parentPage=null,this.currentId=null,this.getCurrentId=n.observable(),this.ctx=null,this.currentParentPage=n.observable(null),this.isVisible=n.observable(!1),this.originalRoute=n.observable(null),this.route=null};var f=r.Page.prototype;f.val=function(e){return h.value(this.getValue()[e])},f.currentChildPage=function(){return this.childManager.currentChildO},f.find=function(e){var n=h.value(e),a=this;if("/"===n.substring(0,1))a=r.page,n=n.slice(1);else for(;"../"===n.substring(0,3);)a=a.currentParentPage&&a.currentParentPage()?a.currentParentPage():a.parentPage,n=n.slice(3);var i=u(n);return t.each(i,function(e,t){a=a.child(t)()}),a},f.find$=function(e){return a(this.find,this)(e)};var g=function(e){return r.useHTML5history?t("base").attr("href")+e:r.Href.hash+e};f.path=function(e){var n=this,a=h.value(e);if(a&&"object"==typeof a&&a.path&&a.params&&!(a instanceof r.Page)){var i=a.path,o=a.params;return n.path(i)+"?"+t.param(o)}var l;if(null==a||""===a)l=n;else{if(!(a instanceof r.Page)){if("/"===a.substring(0,1)){var s=r.page.getFullRoute()().join("/")+a.substring(1);return g(s)}for(var u=0;"../"===a.substring(0,3);)u++,a=a.slice(3);var c=n.getFullRoute()(),d=c.slice(0,c.length-u).join("/"),f=(""===d?"":d+"/")+a;return g(f)}l=a}return g(l.getFullRoute()().join("/"))},f.path$=function(e){return a(this.path,this)(e)},f.async=function(e,t,n,a){var i=this;return function(){l&&l.reject({cancel:!0});var s=e();l=s,a&&a(s.state());var u=Math.random();o=u,s.done(function(){a&&a(s.state()),u===o&&r.navigate(i.path(t))}),s.fail(function(e){a&&a(s.state());var t=e&&e.cancel;u===o&&!t&&n&&r.navigate(i.path(n))})}},f.showPage=function(e,t,n){var a=this,r=a.currentId,i=a.pageRoute?a.pageRoute.params:null,o=a.isVisible();a.currentId=t?t.name||"":"",a.getCurrentId(a.currentId),a.isVisible(!0),n&&a.originalRoute(n),a.route=e,a.pageRoute=t,o?("?"===a.getId()&&r!==a.currentId&&a.show(),t&&i!==t.params&&a.setParams()):(a.setParams(),a.show()),a.childManager.showChild(e)},f.setParams=function(){if(this.pageRoute&&this.pageRoute.params){var e=this.pageRoute.params,a=this.ctx,r=this.val("params")||{};t.isArray(r)?t.each(r,function(t,r){var i=e[r];a[r]?a[r](i):a[r]=n.observable(i)}):t.each(r,function(t,r){var i,o=e[t];i=null==o?h.value(r):o,a[t]?a[t](i):a[t]=n.observable(i)})}if(this.pageRoute){var i=this.getValue().nameParam;i&&("string"==typeof i?this.ctx[i]?this.ctx[i](this.currentId):this.ctx[i]=n.observable(this.currentId):i(this.currentId))}},f.hidePage=function(e){var t=this;"show"!==t.val("urlToggle")?(t.hideElementWrapper(e),t.childManager.hideChild()):e&&e()};var v=function(t){try{n.applyBindingsToDescendants(t.childBindingContext,t.element)}catch(n){r.onBindingError.has()||e.console&&e.console.error&&e.console.error(n),i(t,"onBindingError",{error:n})}};f.init=function(){var e=this;e.cleanElement=e.element.innerHTML;var a=e.val("urlToggle"),r=e.val("id");"?"!==r&&e.getCurrentId(r);var o=n.utils.domData.get(e.element,"__ko_pagerjsBindingData");if(o)return{controlsDescendantBindings:!0};n.utils.domData.set(e.element,"__ko_pagerjsBindingData",e),n.utils.domNodeDisposal.addDisposeCallback(e.element,function(){i(e,"beforeRemove"),e.parentPage&&e.parentPage.children.remove(e),i(e,"afterRemove")});var l=e.getValue();if("none"!==a&&(e.parentPage=e.getParentPage(),e.parentPage.children.push(this),e.hideElement()),e.val("source")&&e.loadSource(e.val("source")),e.ctx=null,l.withOnShow)e.ctx={},e.childBindingContext=e.bindingContext.createChildContext(e.ctx),n.utils.extend(e.childBindingContext,{$page:this});else{var s=l.with||e.bindingContext.$observableData||e.viewModel;if(e.ctx=h.value(s),e.augmentContext(),n.isObservable(s)){var u=n.observable(e.ctx);e.childBindingContext=e.bindingContext.createChildContext(u),n.utils.extend(e.childBindingContext,{$page:this,$observableData:s}),v(e),s.subscribe(function(){u(h.value(s))})}else e.childBindingContext=e.bindingContext.createChildContext(e.ctx),n.utils.extend(e.childBindingContext,{$page:this,$observableData:void 0}),v(e)}if("none"!==a){var c=e.parentPage;c.route&&(c.route[0]===e.getId()||c.route.length&&"?"===e.getId())&&setTimeout(function(){c.showPage(c.route)},0)}else{var d=function(){t(e.element).is(":visible")&&e.showPage([])};setTimeout(d,0),e.getParentPage().isVisible.subscribe(function(e){e&&setTimeout(d,0)})}var f=e.getValue().bind;return n.isObservable(f)&&f(e),{controlsDescendantBindings:!0}},f.augmentContext=function(){var e=this,a=e.val("params");a&&(t.isArray(a)?t.each(a,function(t,a){e.ctx[a]||(e.ctx[a]=n.observable())}):t.each(a,function(t,r){e.ctx[t]||(n.isObservable(r)?e.ctx[t]=r:null===r?(a[t]=n.observable(null),e.ctx[t]=n.observable(null)):e.ctx[t]=n.observable(r))})),this.val("vars")&&t.each(this.val("vars"),function(t,a){e.ctx[t]=n.isObservable(a)?a:n.observable(a)});var r=this.getValue().nameParam;r&&"string"==typeof r&&!e.ctx[r]&&(e.ctx[r]=n.observable(null)),this.setParams()},f.getValue=function(){return this.valueAccessor?h.value(this.valueAccessor()):{}},f.getParentPage=function(){return r.getParentPage(this.bindingContext)},f.getId=function(){return this.val("id")},f.id=function(){var e=this.getCurrentId();return null==e||""===e?this.getId():e},f.sourceUrl=function(e){var t=this;return n.computed("?"===this.getId()?function(){var n;return n=t.val("deep")?[t.currentId].concat(t.route).join("/"):t.currentId,h.value(e).replace("{1}",n)}:function(){return h.value(e)})},f.loadWithOnShow=function(){var e=this;e.withOnShowLoaded&&e.val("sourceCache")===!0||(e.val("withOnShow")(function(a){!e.val("sourceOnShow")&&e.withOnShowLoaded&&(n.cleanNode(t(e.element)),t(e.element).empty(),e.element.innerHTML=e.cleanElement);var r=e.bindingContext.createChildContext(a);e.ctx=a,e.childBindingContext=r,e.augmentContext(),n.utils.extend(r,{$page:e}),v(e),e.route&&e.childManager.showChild(e.route)},e),e.withOnShowLoaded=!0)},f.loadSource=function(e){var a=this.getValue(),i=this,o=this.element,l=null,s=a.loader||r.loader;if("iframe"===a.frame){var u=t("iframe",t(o));0===u.length&&(u=t("<iframe></iframe>"),t(o).append(u)),s&&(l=h.value(s)(i,u),l.load()),u.one("load",function(){l&&l.unload(),a.sourceLoaded&&a.sourceLoaded(i)}),n.applyBindingsToNode(u[0],{attr:{src:this.sourceUrl(e)}})}else{s&&(l=h.value(s)(i,i.element),l.load());var c=function(){l&&l.unload(),i.val("withOnShow")?i.val("withOnShow")&&i.loadWithOnShow():v(i),a.sourceLoaded&&a.sourceLoaded(i),i.route&&i.childManager.showChild(i.route)};if("string"==typeof h.value(e)){var d=h.value(this.sourceUrl(e));m(o,d,function(){c()},i)}else{var f=t(o).children();h.value(e)(this,function(){t.each(f,function(e,t){n.utils.domNodeDisposal.removeNode(t)}),c()})}}};var p=/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,m=function(e,a,r,o){var l,s,u=t(e),h=a.indexOf(" ");h>=0&&(l=a.slice(h,a.length),a=a.slice(0,h));var c=jQuery.ajax({url:a,type:"GET",dataType:"html",complete:function(e,t){r&&u.each(r,s||[e.responseText,t,e])}}).done(function(e){s=arguments,t.each(u.children(),function(e,t){n.utils.domNodeDisposal.removeNode(t)}),u.html(l?jQuery("<div>").append(e.replace(p,"")).find(l):e)});return c.fail(function(){i(o,"onSourceError",{url:a,xhrPromise:c})}),u};f.show=function(t){var n=this.element,a=this;a.showElementWrapper(t),a.val("title")&&(e.document.title=a.val("title")),a.val("sourceOnShow")?(!a.val("sourceCache")||!n.__pagerLoaded__||"number"==typeof a.val("sourceCache")&&n.__pagerLoaded__+1e3*a.val("sourceCache")<r.now())&&(n.__pagerLoaded__=r.now(),a.loadSource(a.val("sourceOnShow"))):a.val("withOnShow")&&a.loadWithOnShow()},f.titleOrId=function(){return this.val("title")||this.id()},f.showElementWrapper=function(e){var t=this;i(t,"beforeShow"),t.showElement(e),t.val("scrollToTop")&&t.element.scrollIntoView(),i(t,"afterShow")},f.showElement=function(e){this.val("showElement")?this.val("showElement")(this,e):this.val("fx")?r.fx[this.val("fx")].showElement(this,e):r.showElement?r.showElement(this,e):t(this.element).show(e)},f.hideElementWrapper=function(e){this.isVisible(!1),i(this,"beforeHide"),this.hideElement(e),i(this,"afterHide")},f.hideElement=function(e){this.val("hideElement")?this.val("hideElement")(this,e):this.val("fx")?r.fx[this.val("fx")].hideElement(this,e):r.hideElement?r.hideElement(this,e):(t(this.element).hide(),e&&e())},f.getFullRoute=function(){return this._fullRoute?this._fullRoute:(this._fullRoute=n.computed(function(){var e=null;return this.currentParentPage&&this.currentParentPage()?(e=this.currentParentPage().getFullRoute()().slice(0),e.push(this.originalRoute()||this.getId()),e):this.parentPage?(e=this.parentPage.getFullRoute()().slice(0),e.push(this.originalRoute()||this.getId()),e):[]},this),this._fullRoute)},f.getRole=function(){return this.val("role")||"next"},f.isStartPage=function(){return"start"===this.getId()||"start"===this.getRole()},f.nullObject=new r.Page,f.nullObject.children=n.observableArray([]),f.child=function(e){var a=this;return null==a._child&&(a._child={}),a._child[e]||(a._child[e]=n.computed(function(){var n=t.grep(this.children(),function(t){return t.id()===e})[0];return n||this.nullObject},this)),a._child[e]},r.getActivePage=function(){for(var e=r.page;null!=e.currentChildPage()();)e=e.currentChildPage()();return e},n.bindingHandlers.page={init:function(e,t,n,a,i){var o=null;return h.value(t())instanceof r.Page?(o=h.value(t()),o.element=e,null==o.allBindingsAccessor&&(o.allBindingsAccessor=n),null==o.viewModel&&(o.viewModel=a),null==o.bindingContext&&(o.bindingContext=i)):o=new r.Page(e,t,n,a,i),o.init()}};var b="page-href";r.useHTML5history=!1,r.rootURI="/",r.dataAttribute=n.computed({read:function(){return b},write:function(e){if(!e){var t=new Error;throw t.message="Data Attribute cannot be blank",t}n.bindingHandlers[b]&&delete n.bindingHandlers[b],b=e,n.bindingHandlers[b]=x}}),r.Href=function(e,t,a,r,i){this.element=e,this.bindingContext=i,this.path=n.observable(),this.pageOrRelativePath=n.observable(t)};var w=r.Href.prototype;w.getParentPage=function(){return r.getParentPage(this.bindingContext)},w.init=function(){var e=this,t=e.getParentPage();e.path=n.computed(function(){var n=h.value(e.pageOrRelativePath()());return t.path(n)})},r.Href.hash="#",w.bind=function(){n.applyBindingsToNode(this.element,{attr:{href:this.path}})},w.update=function(e){this.pageOrRelativePath(e)},r.Href5=function(){r.Href.apply(this,arguments)},r.Href5.prototype=new r.Href,r.Href5.history=e.History,r.Href5.prototype.bind=function(){var e=this;n.applyBindingsToNode(e.element,{attr:{href:e.path},click:function(){var n=e.path();(""===n||"/"===n)&&(n=t("base").attr("href")),r.Href5.history.pushState(null,null,n)}})};var x={init:function(e,t,n,a,i){var o=r.useHTML5history?r.Href5:r.Href,l=new o(e,t,n,a,i);l.init(),l.bind(),e.__ko__page=l},update:function(e,t){e.__ko__page.update(t)}};return n.bindingHandlers[r.dataAttribute()]=x,r.fx={},r.fx.cssAsync=function(e){return{showElement:function(n,a){var r=t(n.element);r.addClass(e),r.show();var i=setInterval(function(){clearInterval(i),r.addClass(e+"-in")},10),o=setInterval(function(){clearInterval(o),a&&a()},300)},hideElement:function(n,a){var r=t(n.element);if(n.pageHiddenOnce){r.removeClass(e+"-in");var i=setInterval(function(){clearInterval(i),a&&a(),r.hide()},300)}else n.pageHiddenOnce=!0,r.hide()}}},r.fx.zoom=r.fx.cssAsync("pagerjs-fx-zoom"),r.fx.flip=r.fx.cssAsync("pagerjs-fx-flip"),r.fx.popout=r.fx.cssAsync("pagerjs-fx-popout-modal"),r.fx.jQuerySync=function(e,n){return{showElement:function(n,a){e.call(t(n.element),300,a)},hideElement:function(e,a){n.call(t(e.element),300,function(){t(e.element).hide()}),a&&a()}}},r.fx.slide=r.fx.jQuerySync(t.fn.slideDown,t.fn.slideUp),r.fx.fade=r.fx.jQuerySync(t.fn.fadeIn,t.fn.fadeOut),r.startHistoryJs=function(t){var n="string"==typeof t?t:null;n&&r.Href5.history.pushState(null,null,n),r.Href5.history.Adapter.bind(e,"statechange",function(){var e=r.Href5.history.getState().url.replace(r.Href5.history.getBaseUrl(),"");s(e)}),r.Href5.history.Adapter.bind(e,"anchorchange",function(){var t=e.location.href.split("#")[1];s(t?"#"+t:"")}),t&&t.noGo||s(r.Href5.history.getState().url.replace(r.Href5.history.getBaseUrl(),""))},r.start=function(n){var a="string"==typeof n?n:null;a&&(e.location.hash=r.Href.hash+a);var i=function(){var t=e.location.href.split("#")[1];s(t?"#"+t:"")};t(e).bind("hashchange",i),n&&n.noGo||i()},r},n=e.define;"function"==typeof n&&"object"==typeof n.amd&&n.amd?n("pager",["knockout","jquery"],function(e,n){return t(n,e)}):e.pager=t($,ko)}(window);